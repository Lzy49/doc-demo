# 大流程

这个问题的答案分为三个部分：

- 输入 URL
- 请求资源
- 资源渲染成页面
# 详
## 输入 URL

这部分工作由浏览器进程执行：

- 对 URL 进行一个补充
- 对当前页面执行`beforeunload` 事件

## 请求资源

请求资源时，浏览器进程会将 URL 发送 网络进程。网络进程进行资源请求。网络进程会做：

### 查询缓存资源

查询本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程，如果没有进行下一步

### 网络请求流程

#### 客户端

- DNS 解析 域名 IP 地址 ， HTTPS 进行 TLS 连接 ，
- TCP/IP 3 次握手 建立与服务器连接
- 构建 HTTP 响应报文并发送

#### 服务端

- 接收 HTTP 请求报文
- 解析后返回响应报文

#### 客户端

解析响应报文：

1. 重定向：301，302 发起新的请求。
2. 根据响应头`Content-Type`字段渲染，如果该字段为`text/html` 则会进入渲染流程

## 渲染

### 准备渲染

在接受到响应报文后，网络进程会通知浏览器进程。浏览器进程会做：

1. 根据域名分配渲染进程，（主域名相同的分配为一个进程）
2. 对渲染进程发起`提交文档`信息
3. 渲染进程接收到后与网络进程建立传输管道，传输数据
4. 传输完成后，渲染进程向浏览器进程返回`确认提交`的消息
5. 浏览器进程在收到`确认提交`的消息后，会更新浏览器界面状态(安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。)

### 渲染流水线

按照渲染的时间顺序，流水线可分为如下几个子阶段：

- 构建 DOM 树
- 样式计算
- 布局
- 分层
- 绘制
- 分块
- 光栅化
- 合成

#### 构建 DOM 树

浏览器通过 HTML 解析器将 HTML 转换为 DOM 树结构。并存在缓存中。

#### 样式计算

1. CSS 文本全部转换为 `styleSheets` 结构中的数据，该结构同时具备了查询和修改功能。
2. 转换样式表中的属性值，使其标准化 (如 `2em`、`blue`、`bold`)。
3. 依据 CSS 继承, 样式层叠 。计算出 DOM 树中每个节点的具体样式

> CSS 继承 ：子元素会继承父级元素的样式
> 样式层叠 ：css 只会用最高级的样式例如`id`选择器 > `*` 选择器。

样式计算阶段的目的是为了计算出 DOM 节点中每个元素的具体样式，这个阶段最终输出的内容是每个 DOM 节点的样式，并被保存在 ComputedStyle 的结构内。

#### 布局

1. 创建布局树

- 遍历 DOM 树中的所有可见节点，并把这些节点加到布局树中；不可见的节点会被布局树忽略掉，例如`head` 标签 ，带有 `dispaly:none` 样式的 DOM。

2. 布局计算

- 通过浏览器，css 计算每个元素的几何坐标位置，并将这些信息保存在布局树中。

#### 分层

对布局树以以下规则进行分层，并生成分层树。

- 拥有层叠上下文属性的元素会被提升为单独的一层 :
  - 定位属性的元素
  - 定义透明属性的元素
  - 使用 CSS 滤镜的元素等
- 需要剪裁（clip）的地方也会被创建为图层。例如 内容益处。

#### 图层绘制

绘制一个元素通常需要好几条绘制指令，因为每个元素的背景、前景、边框都需要单独的指令去绘制。
为每个图层生成绘制列表，并将其提交到合成线程。

#### 光栅化（raster）操作

基于视口的大小，合成线程将图层分成图块（512 x 512 或 256 x 256 的小块），按照视口附近的图块来优先生成位图， 而图块转换位图的过程就是在**光栅化线程池中**执行的，一般由 CPU 进行快速渲染。

#### 合成和显示

所有图块都被光栅化，合成线程就会生成一个绘制图块的命令——“DrawQuad”，然后将该命令提交给浏览器进程。
浏览器进程里面有一个叫 viz 的组件，用来接收合成线程发过来的 DrawQuad 命令，然后根据 DrawQuad 命令，将其页面内容绘制到内存中，最后再将内存显示在屏幕上。

# 总结

从 URL 输入到页面展示到底发生了什么：

- 输入 URL
  - 处理当前页面
  - 处理 URL
- 请求资源
  - 查缓存
  - HTTPS->TLS, IP 地址->DNS
  - TCP/IP 连接服务器
  - 发请求
- 解析响应
  - 重定向 301,302
  - 判断`Content-type`
- 渲染准备
  - 根据域名建立渲染进程
  - 渲染进程去请求进程取资源
- 渲染
  - HTML -> DOM 树，
  - CSS  -> styleSheets (样式表)
  - DOM 树 + styleSheets + 浏览器信息 -(显示 DOM，DOM 几何位置组成)-> 布局树
  - 布局树 -(层叠上下文属性，益处内容)-> 分层树
  - 图层 -> -(每一条样式都是一条指令)-> 绘制指令\*N-> 绘制列表
  - 图层 -> 图块 -(栅格化)-> 位图
  - 合成器 -(DrawQuad)-> 浏览器线程，页面内容 -(DrawQuad)-> 内存 -> 内存显示在屏幕上。
